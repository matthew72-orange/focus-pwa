<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Focus Timer PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-180.png">
<style>
  :root{--bg:#0b0b0c;--fg:#f7f7f8;--muted:#9aa0a6;--accent:#4f8cff;}
  html,body{height:100%;}
  body{margin:0; font-family:-apple-system, system-ui, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Noto Sans JP", sans-serif; background:var(--bg); color:var(--fg); display:flex; align-items:center; justify-content:center;}
  .card{width:min(720px, 92vw); padding:20px 20px 28px; border-radius:20px; background:#151517; box-shadow:0 10px 30px rgba(0,0,0,.35);}
  h1{margin:4px 0 12px; font-size:22px; font-weight:700;}
  label{display:block; margin:12px 0 4px; color:var(--muted);}
  input, select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a2a2e; background:#0f0f11; color:var(--fg); font-size:18px; outline:none;}
  button{appearance:none; border:0; border-radius:14px; padding:12px 16px; font-size:18px; font-weight:700; color:white; background:var(--accent); cursor:pointer;}
  .row{display:flex; gap:12px; align-items:center;}
  .row>*{flex:1}
  .muted{color:var(--muted); font-size:14px;}
  .center{display:flex; align-items:center; justify-content:center; text-align:center;}
  .timer{font-variant-numeric:tabular-nums; font-size:64px; letter-spacing:1px; margin:6px 0 18px;}
  .affirm{font-size:22px; margin:6px 0 10px;}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#232327; color:#c9ccd1; font-size:13px;}
  .stack{display:flex; flex-direction:column; gap:12px;}
  .hidden{display:none !important;}
</style>
</head>
<body>
  <div class="card">
    <h1>Focus Timer</h1>

    <div id="setup" class="stack">
      <div>
        <label>ã‚„ã‚‹ã“ã¨</label>
        <input id="task" placeholder="è‹±èª/æ•°å­¦/èª­æ›¸ ãªã©" autocomplete="on">
      </div>
      <div class="row">
        <div>
          <label>ç›®æ¨™æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <select id="mins">
            <option>1</option><option>25</option><option selected>50</option><option>90</option><option>120</option>
          </select>
        </div>
        <div>
          <label>é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ãƒ»ã‚µãƒ¼ãƒçµŒç”±ï¼‰</label>
          <input id="email" placeholder="family@example.com">
        </div>
      </div>
      <div class="muted">â€»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯ã‚µãƒ¼ãƒã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®šãŒå¿…è¦ã§ã™ï¼ˆ<code>config.endpoint</code> ã‚’ç·¨é›†ï¼‰ã€‚</div>
      <div class="row">
        <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="installBtn" class="hidden">ãƒ›ãƒ¼ãƒ è¿½åŠ </button>
      </div>
    </div>

    <div id="run" class="hidden center" style="flex-direction:column;">
      <div class="pill" id="taskLabel">Task</div>
      <div class="affirm">é›†ä¸­ä¸­ã€‚ã‚ãŸã—ã¯ã‚„ã‚Œã‚‹ã€‚ğŸ’ª</div>
      <div class="timer" id="remain">00:00</div>
      <div class="row" style="width:100%;"><button id="stopBtn" style="background:#e64a4a">ä¸­æ–­ï¼ˆFailï¼‰</button></div>
      <div class="muted" style="margin-top:10px">âš ï¸ ã“ã®ç”»é¢ã‹ã‚‰é›¢ã‚Œã‚‹ã¨å³ Fail ã«ãªã‚Šã¾ã™ã€‚</div>
    </div>

  </div>

<script>
// ------- åŸºæœ¬è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ç·¨é›†ï¼‰ -------
const config = {
  endpoint: "https://example.com/focus_log", // â† ã‚ãªãŸã®GAS/Flask URLã«å¤‰æ›´
  enablePost: false // ã‚µãƒ¼ãƒæœªè¨­å®šãªã‚‰ false ã®ã¾ã¾ã§OKï¼ˆPOSTã—ãªã„ï¼‰
};

let audioCtx = null, audioUnlocked = false;
function initAudioUnlock(){
  if (audioUnlocked) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if (!Ctx) return;
  audioCtx = new Ctx();
  // ã”ãçŸ­ã„å¯è´ãƒˆãƒ¼ãƒ³ã§â€œéŸ³ã‚’è§£éŒ â€
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  gain.gain.value = 0.001; // ã»ã¼ç„¡éŸ³
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  setTimeout(()=>{ osc.stop(); audioUnlocked = true; }, 60);
}

async function ensureAudioReady(){
  if (!audioCtx) initAudioUnlock();
  try { await audioCtx.resume(); } catch(e){}
}
window.addEventListener('pointerdown', ensureAudioReady, {passive:true});
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) ensureAudioReady();
});

  
// æˆåŠŸ/å¤±æ•—ç”¨ã®ç°¡æ˜“ãƒãƒ£ã‚¤ãƒ ï¼ˆfallbackï¼‰
async function beep(freq=880, ms=220){
  await ensureAudioReady();
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  gain.gain.value = 0.18;             // â† å°‘ã—å¤§ãã‚ï¼ˆå¿…è¦ãªã‚‰0.25ã¾ã§ï¼‰
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  setTimeout(()=>{
    try{ gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.12); }catch(e){}
  }, Math.max(60, ms-120));
  setTimeout(()=>{ try{ osc.stop(); }catch(e){} }, ms+80);
}
  
// ------- PWA: SWç™»éŒ² -------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

// ------- ç”»é¢è¦ç´  -------
const $ = s => document.querySelector(s);
const setup = $('#setup'), run = $('#run');
const startBtn = $('#startBtn'), stopBtn = $('#stopBtn');
const taskInput = $('#task'), minsSel = $('#mins'), emailInput = $('#email');
const remain = $('#remain'), taskLabel = $('#taskLabel');
let startAt = null, targetSec = 0, tHandle = null, currentTask = "", userEmail = "";
let keepAwakeVideo = null;

// ------- ãƒ›ãƒ¼ãƒ è¿½åŠ ï¼ˆä¸»ã«Android/ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ -------
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  const ib = $('#installBtn');
  ib.classList.remove('hidden');
  ib.onclick = async () => { deferredPrompt.prompt(); deferredPrompt = null; ib.classList.add('hidden'); };
});

// ------- ç”»é¢é›¢è„±ï¼Fail -------
document.addEventListener('visibilitychange', () => {
  if (document.hidden) endSession(false, 'left-app');
});

// ------- ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚¹ãƒˆãƒƒãƒ— -------
startBtn.addEventListener('click', async () => {
  currentTask = taskInput.value.trim() || 'Untitled';
  userEmail = emailInput.value.trim();
  const mins = parseInt(minsSel.value, 10);
  startSession(currentTask, mins);
});

stopBtn.addEventListener('click', () => endSession(false, 'manual'));

function startSession(task, mins){
  initAudioUnlock(); // â† è¿½åŠ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã«éŸ³ã‚’è§£éŒ 
  startAt = new Date();
  targetSec = mins * 60;
  setup.classList.add('hidden');
  run.classList.remove('hidden');
  taskLabel.textContent = task;
  updateTimer(); tHandle = setInterval(updateTimer, 250);

  // iOSã‚¹ãƒªãƒ¼ãƒ—æŠ‘æ­¢ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã®ã¿æœ‰åŠ¹ï¼‰
  if (!keepAwakeVideo) {
    const v = document.createElement('video');
    v.setAttribute('playsinline','');
    v.muted = true; v.loop = true;
    // 1pxã®ç„¡éŸ³MP4ãƒ‡ãƒ¼ã‚¿ï¼ˆæ¥µå°ï¼‰
    v.src = "data:video/mp4;base64,AAAAIGZ0eXBpc28yAAAAAGlzbzJpc28yYXZjMQAAAAhmcmVlAAAAH21kYXQAAAAAAAABAAAAGG1vb3YAAABsbXZoZAAAAAB8AAABcAAAAgABAAAB9AAACABAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABA==";
    v.play().catch(()=>{});
    keepAwakeVideo = v;
  }

  // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã®éŸ³å£°æ¨©é™ã‚’ç¢ºä¿
  try { window.speechSynthesis.cancel(); } catch(e){}
}

function updateTimer(){
  const elapsed = Math.floor((Date.now()-startAt.getTime())/1000);
  const left = Math.max(0, targetSec - elapsed);
  remain.textContent = fmt(left);
  if (left === 0) endSession(true, 'target');
}

async function endSession(success, reason){
  if (!startAt) return;
  clearInterval(tHandle); tHandle = null;
  const endedAt = new Date();
  const minutes = Math.floor((endedAt - startAt)/60000);
  const payload = {
    task: currentTask, email: userEmail || null,
    started_at: startAt.toISOString(), ended_at: endedAt.toISOString(),
    success, reason, minutes
  };

  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆéŸ³/èª­ã¿ä¸Šã’/ãƒã‚¤ãƒ–ï¼‰
  try { navigator.vibrate && navigator.vibrate(success ? [40,40,40] : [160]); } catch(e){}
  if (success) {
    beep(1046, 150); setTimeout(()=>beep(1318, 180), 160); // æˆåŠŸãƒãƒ£ã‚¤ãƒ 
    speak(`ãŠç–²ã‚Œæ§˜ã€‚ç›®æ¨™æ™‚é–“ã€${minutes} åˆ†ã€‚ã²ã¨æ¯ã„ã‚Œã¾ã—ã‚‡ã†ã‹ï¼Ÿ`);
  } else {
    beep(392, 200); setTimeout(()=>beep(330, 220), 220);   // å¤±æ•—ãƒãƒ£ã‚¤ãƒ 
    speak(`ç€åº§ã—ã¦ã‹ã‚‰ ${minutes} åˆ†ã—ã‹çµŒã£ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†å°‘ã—é ‘å¼µã‚Œã¾ã™ã€‚`);
  }
  
  // ã‚µãƒ¼ãƒPOSTï¼ˆä»»æ„ï¼‰
  if (config.enablePost) {
    fetch(config.endpoint, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).catch(()=>{});
  }

  // â˜… æˆåŠŸï¼å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜UIã¯ä¸€æ™‚çš„ã«éè¡¨ç¤ºï¼‰
  const olds = Array.from(run.children);
  olds.forEach(el => el.classList.add('hidden'));

  const msg = document.createElement("div");
  msg.style.fontSize = "22px";
  msg.style.margin = "20px 0";
  msg.textContent = success
    ? `ğŸ‰ ãŠç–²ã‚Œæ§˜ï¼${minutes}åˆ†é”æˆã—ã¾ã—ãŸï¼`
    : `ğŸ’¤ ${minutes}åˆ†ã§ä¸­æ–­ã•ã‚Œã¾ã—ãŸ`;
  run.appendChild(msg);

  // 4ç§’å¾Œã«åˆæœŸç”»é¢ã¸æˆ»ã™ï¼ˆUIã‚‚å…ƒã«æˆ»ã™ï¼‰
  setTimeout(() => {
    run.removeChild(msg);
    olds.forEach(el => el.classList.remove('hidden'));
    run.classList.add('hidden');
    setup.classList.remove('hidden');
    startAt = null;
    if (keepAwakeVideo){
      try{ keepAwakeVideo.pause(); }catch(e){}
      keepAwakeVideo.remove(); keepAwakeVideo=null;
    }
  }, 4000);
} // â†â†â† â˜… ã“ã‚ŒãŒ endSession() ã‚’é–‰ã˜ã‚‹ã‚«ãƒƒã‚³
// ï¼ˆã“ã®ä¸‹ã« function speak(...) / function fmt(...) ãŒç¶šãï¼‰
  
let jaVoice = null;
function pickJaVoice(){
  const voices = window.speechSynthesis?.getVoices?.() || [];
  // æ—¥æœ¬èªå„ªå…ˆï¼ˆKyoko/Otoya/â€œja-JPâ€ãªã©ï¼‰
  jaVoice = voices.find(v => (v.lang||"").toLowerCase().startsWith("ja"))
        || voices.find(v => /kyoko|otoya/i.test(v.name||""))
        || null;
}
if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = pickJaVoice;
  // ç«¯æœ«ã«ã‚ˆã£ã¦ã¯å³å–å¾—ã§ãã‚‹ã“ã¨ã‚‚ã‚ã‚‹
  setTimeout(pickJaVoice, 300);
}

function speak(text){
  try{
    if (!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    if (jaVoice) u.voice = jaVoice;
    u.lang = 'ja-JP'; u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
 
function fmt(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
}
</script>
</body>
</html>
